import numpy as np
import pytest

from functions_iterative import TimeScenarioParameter
from multi_stock_bellman_value_calculation import *
from reservoir_management import MultiStockManagement
from type_definition import time_list_area_value_to_array


def test_bellman_value_iterative_method(
    param: TimeScenarioParameter,
    multi_stock_management_two_nodes: MultiStockManagement,
    starting_pt: Dict[AreaIndex, float],
) -> None:

    (
        bell_costs,
        cost_approx,
        _,
        levels,
        opt_trajectory,
        _,
    ) = iter_bell_vals(
        param=param,
        multi_stock_management=multi_stock_management_two_nodes,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        saving_dir="dev/test",
        name_solver="CLP",
        nSteps_bellman=5,
        starting_pt=starting_pt,
        precision=1e-3,
        method="lines",
        correlations=None,
        divisor={"euro": 1e8, "energy": 1e4},
        verbose=False,
    )

    assert cost_approx.estimators[TimeScenarioIndex(0, 0)].inputs == pytest.approx(
        np.array(
            [
                [0.0, -322182.0],
                [306936.0, 419664.0],
                [-0.0, 419664.0],
                [73173.435482, 419663.750788],
                [73173.435482, 419663.750788],
            ]
        )
    )

    assert np.array(
        [[c for c in bell_costs[WeekIndex(w)]] for w in range(param.len_week)]
    ) == pytest.approx(
        np.array(
            [
                [
                    7.76674441e09,
                    4.80369515e09,
                    5.40618880e09,
                    4.34131730e09,
                    2.37118782e09,
                    4.34131730e09,
                    1.40758441e09,
                    4.34131730e09,
                    8.39921586e08,
                    5.06192598e09,
                ],
                [
                    9.74681995e09,
                    9.10017825e09,
                    7.27650554e09,
                    6.04989294e09,
                    4.19266724e09,
                    6.04989294e09,
                    2.80455544e09,
                    6.04989294e09,
                    1.71624509e09,
                    6.79063717e09,
                ],
                [
                    8.64975258e09,
                    8.27833372e09,
                    5.99586240e09,
                    4.88621754e09,
                    2.91971430e09,
                    4.60841860e09,
                    1.51622180e09,
                    4.60841860e09,
                    5.27694940e08,
                    5.47221713e09,
                ],
                [
                    7.62534237e09,
                    6.51876717e09,
                    4.82719701e09,
                    3.63892261e09,
                    1.85896484e09,
                    3.27892211e09,
                    1.29872290e09,
                    3.59118995e09,
                    1.15722009e09,
                    4.83681365e09,
                ],
                [
                    8.42522049e09,
                    4.16306576e09,
                    5.52260982e09,
                    3.80560352e09,
                    3.17704702e09,
                    3.80560352e09,
                    1.82419566e09,
                    4.03718694e09,
                    1.10591510e09,
                    5.25550566e09,
                ],
            ]
        )
    )

    assert time_list_area_value_to_array(
        levels, param, multi_stock_management_two_nodes.areas
    )[::-1] == pytest.approx(
        np.array(
            [
                [
                    [0.0, 867867.287],
                    [347041.07, 0.0],
                    [175340.436, 867867.287],
                    [347041.07, 396540.564],
                    [409896.721, 867867.287],
                    [347041.07, 927000.529],
                    [589466.8605, 867867.287],
                    [347041.07, 1333106.7645],
                    [769037.0, 867867.287],
                    [347041.07, 1739213.0],
                ],
                [
                    [0.0, 874681.07767224],
                    [333244.07, 0.0],
                    [178416.584, 874681.07767224],
                    [333244.07, 403497.416],
                    [486031.384, 874681.07767224],
                    [333244.07, 1099182.616],
                    [627534.192, 874681.07767224],
                    [333244.07, 1419197.808],
                    [769037.0, 874681.07767224],
                    [333244.07, 1739213.0],
                ],
                [
                    [0.0, 1001638.10309647],
                    [319468.07, 0.0],
                    [180723.695, 1001638.10309647],
                    [319468.07, 408715.055],
                    [488338.495, 1001638.10309647],
                    [319468.07, 1104400.255],
                    [628687.7475, 1001638.10309647],
                    [319468.07, 1421806.6275],
                    [769037.0, 1001638.10309647],
                    [319468.07, 1739213.0],
                ],
                [
                    [0.0, 979455.23183235],
                    [305692.07, 0.0],
                    [183030.806, 979455.23183235],
                    [305692.07, 413932.694],
                    [491414.643, 979455.23183235],
                    [305692.07, 1111357.107],
                    [630225.8215, 979455.23183235],
                    [305692.07, 1425285.0535],
                    [769037.0, 979455.23183235],
                    [305692.07, 1739213.0],
                ],
                [
                    [0.0, 888184.40213413],
                    [291825.07, 0.0],
                    [185337.917, 888184.40213413],
                    [291825.07, 419150.333],
                    [493721.754, 888184.40213413],
                    [291825.07, 1116574.746],
                    [631379.377, 888184.40213413],
                    [291825.07, 1427893.873],
                    [769037.0, 888184.40213413],
                    [291825.07, 1739213.0],
                ],
            ]
        )
    )

    assert timescenario_area_value_to_array(
        opt_trajectory, param, multi_stock_management_two_nodes.areas
    ) == pytest.approx(
        np.array(
            [
                [[291825.07, 888184.40213413]],
                [[180723.695, 501314.68423129]],
                [[194499.69, 523497.55309647]],
                [[175340.436, 396540.52767224]],
                [[162266.807, 366973.943]],
            ]
        )
    )


def test_bellman_value_iterative_method_with_sddp(
    param: TimeScenarioParameter,
    multi_stock_management_two_nodes: MultiStockManagement,
    starting_pt: Dict[AreaIndex, float],
) -> None:

    _, bellman_costs, _, _ = iter_bell_vals_v2(
        param=param,
        multi_stock_management=multi_stock_management_two_nodes,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        saving_dir="dev/test",
        starting_pt=starting_pt,
        normalization={"euro": 1e9, "energy": 1e4},
        name_solver="CLP",
        maxiter=3,
        precision=1e-2,
        verbose=False,
    )

    assert np.array(bellman_costs) == pytest.approx(
        np.array(
            [
                [
                    7.36522585e09,
                    7.30431203e09,
                    7.24339821e09,
                    7.18248439e09,
                    7.12157057e09,
                    7.06065675e09,
                    6.99974292e09,
                    6.93882910e09,
                    6.87791528e09,
                    6.81700146e09,
                    6.75608764e09,
                    6.71614827e09,
                    6.67807713e09,
                    6.64000599e09,
                    6.60193485e09,
                    6.56386371e09,
                    6.52579257e09,
                    6.48772143e09,
                    6.44965030e09,
                    6.41157916e09,
                    6.37350802e09,
                    6.33543688e09,
                    6.29736574e09,
                    6.25929460e09,
                    6.22122346e09,
                    6.18315233e09,
                    6.14508119e09,
                    6.10701005e09,
                    6.06893891e09,
                    6.03086777e09,
                    5.99279663e09,
                    5.95472549e09,
                    5.91665436e09,
                    5.87858322e09,
                    5.84051208e09,
                    5.80244094e09,
                    5.76436980e09,
                    5.72629866e09,
                    5.68822752e09,
                    5.65015639e09,
                    5.61208525e09,
                    5.57401411e09,
                    5.53594297e09,
                    5.49787183e09,
                    5.45980069e09,
                    5.42172955e09,
                    5.38365842e09,
                    5.34558728e09,
                    5.30751614e09,
                    5.26944500e09,
                    5.23137386e09,
                    5.19330272e09,
                    5.15523158e09,
                    5.11716044e09,
                    5.07908931e09,
                    5.04101817e09,
                    5.00294703e09,
                    4.96487589e09,
                    4.92680475e09,
                    4.88873361e09,
                    4.85066247e09,
                    4.81259134e09,
                    4.77452020e09,
                    4.73644906e09,
                    4.69837792e09,
                    4.66030678e09,
                    4.62223564e09,
                    4.58416450e09,
                    4.54609337e09,
                    4.50802223e09,
                    4.46995109e09,
                    4.43187995e09,
                    4.39380881e09,
                    4.35573767e09,
                    4.31766653e09,
                    4.27959540e09,
                    4.24152426e09,
                    4.20345312e09,
                    4.16538198e09,
                    4.12731084e09,
                    4.08923970e09,
                    4.05116856e09,
                    4.01309743e09,
                    3.97502629e09,
                    3.93695515e09,
                    3.89888401e09,
                    3.86081287e09,
                    3.82274173e09,
                    3.78467059e09,
                    3.74659945e09,
                    3.70852832e09,
                    3.67045718e09,
                    3.63238604e09,
                    3.59431490e09,
                    3.55624376e09,
                    3.51817262e09,
                    3.48010148e09,
                    3.44203035e09,
                    3.40395921e09,
                    3.36588807e09,
                    3.32781693e09,
                ],
                [
                    5.70355593e09,
                    5.62788216e09,
                    5.55220840e09,
                    5.47653464e09,
                    5.40086088e09,
                    5.32518712e09,
                    5.24951335e09,
                    5.17383959e09,
                    5.09816583e09,
                    5.02249207e09,
                    4.94681830e09,
                    4.87114454e09,
                    4.79768691e09,
                    4.74485583e09,
                    4.70118985e09,
                    4.66311871e09,
                    4.62504757e09,
                    4.58697643e09,
                    4.54890530e09,
                    4.51083416e09,
                    4.47276302e09,
                    4.43469188e09,
                    4.39662074e09,
                    4.35854960e09,
                    4.32047846e09,
                    4.28240733e09,
                    4.24433619e09,
                    4.20626505e09,
                    4.16819391e09,
                    4.13012277e09,
                    4.09205163e09,
                    4.05398049e09,
                    4.01590936e09,
                    3.97783822e09,
                    3.93976708e09,
                    3.90169594e09,
                    3.86362480e09,
                    3.82555366e09,
                    3.78748252e09,
                    3.74941139e09,
                    3.71134025e09,
                    3.67326911e09,
                    3.63519797e09,
                    3.59712683e09,
                    3.55905569e09,
                    3.52098455e09,
                    3.48291342e09,
                    3.44484228e09,
                    3.40677114e09,
                    3.36870000e09,
                    3.33062886e09,
                    3.29255772e09,
                    3.25448658e09,
                    3.21641544e09,
                    3.17834431e09,
                    3.14027317e09,
                    3.10220203e09,
                    3.06413089e09,
                    3.02605975e09,
                    2.98798861e09,
                    2.94991747e09,
                    2.91184634e09,
                    2.87377520e09,
                    2.83570406e09,
                    2.79763292e09,
                    2.75956178e09,
                    2.72149064e09,
                    2.68341950e09,
                    2.64534837e09,
                    2.60727723e09,
                    2.56920609e09,
                    2.53113495e09,
                    2.49306381e09,
                    2.45499267e09,
                    2.41692153e09,
                    2.37885040e09,
                    2.34077926e09,
                    2.30270812e09,
                    2.26463698e09,
                    2.22656584e09,
                    2.18849470e09,
                    2.15042356e09,
                    2.11235243e09,
                    2.07428129e09,
                    2.03621015e09,
                    1.99813901e09,
                    1.96006787e09,
                    1.92199673e09,
                    1.88392559e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                    1.87189846e09,
                ],
                [
                    3.45876029e09,
                    3.38343792e09,
                    3.30811554e09,
                    3.23279316e09,
                    3.15747079e09,
                    3.08569572e09,
                    3.02179468e09,
                    2.95789365e09,
                    2.89399261e09,
                    2.83009158e09,
                    2.76619054e09,
                    2.70228951e09,
                    2.63838847e09,
                    2.57448744e09,
                    2.51058640e09,
                    2.44668537e09,
                    2.38278433e09,
                    2.31888330e09,
                    2.25498226e09,
                    2.19108123e09,
                    2.12718020e09,
                    2.08351668e09,
                    2.04544554e09,
                    2.00737440e09,
                    1.96930326e09,
                    1.93123213e09,
                    1.89316099e09,
                    1.85508985e09,
                    1.81701871e09,
                    1.77894757e09,
                    1.74087643e09,
                    1.70280529e09,
                    1.66473416e09,
                    1.62666302e09,
                    1.58859188e09,
                    1.55052074e09,
                    1.51244960e09,
                    1.47437846e09,
                    1.43630732e09,
                    1.39823619e09,
                    1.37226164e09,
                    1.34941896e09,
                    1.32657627e09,
                    1.30373359e09,
                    1.28089091e09,
                    1.25804822e09,
                    1.23520554e09,
                    1.21236286e09,
                    1.18952017e09,
                    1.16667749e09,
                    1.14383481e09,
                    1.12099213e09,
                    1.09814944e09,
                    1.07530676e09,
                    1.05246408e09,
                    1.02962139e09,
                    1.00677871e09,
                    9.83936026e08,
                    9.61093343e08,
                    9.38250660e08,
                    9.15407977e08,
                    8.92565294e08,
                    8.79178727e08,
                    8.67757385e08,
                    8.56336043e08,
                    8.44914702e08,
                    8.33493360e08,
                    8.22072019e08,
                    8.10650677e08,
                    7.99229336e08,
                    7.87807994e08,
                    7.76386652e08,
                    7.64965311e08,
                    7.53543969e08,
                    7.42122628e08,
                    7.30701286e08,
                    7.19279944e08,
                    7.07858603e08,
                    6.96437261e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                    6.95203265e08,
                ],
                [
                    2.04183746e09,
                    1.97793642e09,
                    1.91403539e09,
                    1.85013435e09,
                    1.78623332e09,
                    1.72233229e09,
                    1.65843125e09,
                    1.59453022e09,
                    1.53062918e09,
                    1.48391496e09,
                    1.44666372e09,
                    1.40941248e09,
                    1.37216125e09,
                    1.33491001e09,
                    1.29765877e09,
                    1.26040753e09,
                    1.22315629e09,
                    1.18590506e09,
                    1.14865382e09,
                    1.11140258e09,
                    1.07415134e09,
                    1.03690011e09,
                    9.99648869e08,
                    9.62397631e08,
                    9.25146394e08,
                    8.87895156e08,
                    8.50643918e08,
                    8.13392681e08,
                    7.76141443e08,
                    7.38890205e08,
                    7.01638968e08,
                    6.83662826e08,
                    6.72241484e08,
                    6.60820143e08,
                    6.49398801e08,
                    6.37977459e08,
                    6.26556118e08,
                    6.15134776e08,
                    6.03713435e08,
                    5.92292093e08,
                    5.80870752e08,
                    5.69449410e08,
                    5.58028068e08,
                    5.46606727e08,
                    5.35185385e08,
                    5.23764044e08,
                    5.12342702e08,
                    5.00921360e08,
                    4.89500019e08,
                    4.78078677e08,
                    4.66657336e08,
                    4.55235994e08,
                    4.43814653e08,
                    4.32393311e08,
                    4.20971969e08,
                    4.09550628e08,
                    3.98129286e08,
                    3.86707945e08,
                    3.75286603e08,
                    3.63865261e08,
                    3.52443920e08,
                    3.41022578e08,
                    3.29601237e08,
                    3.18179895e08,
                    3.06758553e08,
                    2.95337212e08,
                    2.83915870e08,
                    2.72494529e08,
                    2.61073187e08,
                    2.49651846e08,
                    2.38230504e08,
                    2.26809162e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                    2.25688105e08,
                ],
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
            ]
        )
    )
