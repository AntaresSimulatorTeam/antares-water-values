from functions_iterative import (
    TimeScenarioParameter,
    ReservoirManagement,
)
from multi_stock_bellman_value_calculation import *
from calculate_reward_and_bellman_values import (
    MultiStockManagement,
)
from read_antares_data import Reservoir
import numpy as np
import pytest


def test_bellman_value_iterative_method() -> None:

    param = TimeScenarioParameter(len_week=5, len_scenario=1)

    reservoir_1 = Reservoir("test_data/two_nodes", "area_1")
    reservoir_management_1 = ReservoirManagement(
        reservoir=reservoir_1,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    reservoir_2 = Reservoir("test_data/two_nodes", "area_2")
    reservoir_management_2 = ReservoirManagement(
        reservoir=reservoir_2,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    multi_management = MultiStockManagement(
        [reservoir_management_1, reservoir_management_2]
    )

    (
        bell_costs,
        _,
        _,
        levels,
        opt_trajectory,
        _,
    ) = iter_bell_vals(
        param=param,
        multi_stock_management=multi_management,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        name_solver="XPRESS_LP",
        nSteps_bellman=5,
        starting_pt=np.array(
            [
                mng.reservoir.bottom_rule_curve[0] * 0.7
                + mng.reservoir.upper_rule_curve[0] * 0.3
                for mng in multi_management.dict_reservoirs.values()
            ]
        ),
        maxiter=10,
        precision=1e-3,
        method="lines",
        correlations=None,
        interp_mode=False,
        divisor={"euro": 1e8, "energy": 1e4},
        rounding=6,
        verbose=False,
        keep_intermed_res=False,
        already_init=True,
    )

    assert bell_costs == pytest.approx(
        np.array(
            [
                [
                    1.00000082e16,
                    1.00000026e16,
                    1.00000029e16,
                    1.00000013e16,
                    1.00000007e16,
                    1.00000013e16,
                    1.00000008e16,
                    1.00000028e16,
                    1.00000014e16,
                    1.00000059e16,
                ],
                [
                    1.00000098e16,
                    1.00000049e16,
                    1.00000048e16,
                    1.00000034e16,
                    1.00000017e16,
                    1.00000034e16,
                    1.00000008e16,
                    1.00000047e16,
                    1.00000010e16,
                    1.00000082e16,
                ],
                [
                    1.00000086e16,
                    1.00000063e16,
                    1.00000039e16,
                    1.00000027e16,
                    1.00000009e16,
                    1.00000027e16,
                    1.00000008e16,
                    1.00000036e16,
                    1.00000013e16,
                    1.00000062e16,
                ],
                [
                    1.00000072e16,
                    1.00000055e16,
                    1.00000029e16,
                    1.00000018e16,
                    1.00000001e16,
                    1.00000018e16,
                    1.00000005e16,
                    1.00000028e16,
                    1.00000009e16,
                    1.00000052e16,
                ],
                [
                    1.00000056e16,
                    1.00000035e16,
                    1.00000027e16,
                    1.00000017e16,
                    1.00000000e16,
                    1.00000017e16,
                    1.00000004e16,
                    1.00000027e16,
                    1.00000008e16,
                    1.00000050e16,
                ],
            ]
        )
    )

    assert levels == pytest.approx(
        np.array(
            [
                [
                    [0.0, 396540.568],
                    [333244.07, 0.0],
                    [175340.436, 396540.568],
                    [333244.07, 396540.564],
                    [409896.721, 396540.568],
                    [333244.07, 927000.529],
                    [589466.8605, 396540.568],
                    [333244.07, 1333106.7645],
                    [769037.0, 396540.568],
                    [333244.07, 1739213.0],
                ],
                [
                    [0.0, 403497.416],
                    [319468.07, 0.0],
                    [178416.584, 403497.416],
                    [319468.07, 403497.416],
                    [486031.384, 403497.416],
                    [319468.07, 1099182.616],
                    [627534.192, 403497.416],
                    [319468.07, 1419197.808],
                    [769037.0, 403497.416],
                    [319468.07, 1739213.0],
                ],
                [
                    [0.0, 408715.055],
                    [305692.07, 0.0],
                    [180723.695, 408715.055],
                    [305692.07, 408715.055],
                    [488338.495, 408715.055],
                    [305692.07, 1104400.255],
                    [628687.7475, 408715.055],
                    [305692.07, 1421806.6275],
                    [769037.0, 408715.055],
                    [305692.07, 1739213.0],
                ],
                [
                    [0.0, 413932.694],
                    [291825.07, 0.0],
                    [183030.806, 413932.694],
                    [291825.07, 413932.694],
                    [491414.643, 413932.694],
                    [291825.07, 1111357.107],
                    [630225.8215, 413932.694],
                    [291825.07, 1425285.0535],
                    [769037.0, 413932.694],
                    [291825.07, 1739213.0],
                ],
                [
                    [0.0, 628377.6569],
                    [277853.0681, 0.0],
                    [185337.917, 628377.6569],
                    [277853.0681, 419150.333],
                    [493721.754, 628377.6569],
                    [277853.0681, 1116574.746],
                    [631379.377, 628377.6569],
                    [277853.0681, 1427893.873],
                    [769037.0, 628377.6569],
                    [277853.0681, 1739213.0],
                ],
            ]
        )
    )

    assert opt_trajectory == pytest.approx(
        np.array(
            [
                [[277853.0681], [628377.6569]],
                [[291825.07], [413932.698]],
                [[305692.07], [408715.055]],
                [[319468.07], [403497.416]],
                [[333244.07], [396540.56733333]],
                [[347041.07], [366973.943]],
            ]
        )
    )


def test_bellman_value_iterative_method_with_sddp() -> None:

    param = TimeScenarioParameter(len_week=5, len_scenario=1)

    reservoir_1 = Reservoir("test_data/two_nodes", "area_1")
    reservoir_management_1 = ReservoirManagement(
        reservoir=reservoir_1,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    reservoir_2 = Reservoir("test_data/two_nodes", "area_2")
    reservoir_management_2 = ReservoirManagement(
        reservoir=reservoir_2,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    multi_management = MultiStockManagement(
        [reservoir_management_1, reservoir_management_2]
    )

    _, bellman_costs, _, _ = iter_bell_vals_v2(
        param=param,
        multi_stock_management=multi_management,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        starting_pt=np.array(
            [
                mng.reservoir.bottom_rule_curve[0] * 0.7
                + mng.reservoir.upper_rule_curve[0] * 0.3
                for mng in multi_management.dict_reservoirs.values()
            ]
        ),
        normalization={"euro": 1e9, "energy": 1e4},
        name_solver="XPRESS_LP",
        maxiter=10,
        precision=1e-2,
        interp_mode=False,
        verbose=False,
    )

    assert np.array(bellman_costs) == pytest.approx(
        np.array(
            [
                [
                    6.67042708e08,
                    6.15382916e08,
                    5.63723124e08,
                    5.12063332e08,
                    4.60403540e08,
                    4.08743748e08,
                    3.57083955e08,
                    3.05424163e08,
                    2.53764371e08,
                    2.02104579e08,
                    1.50444787e08,
                    9.87849950e07,
                    4.71252030e07,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    4.08074257e06,
                    2.99106386e07,
                    5.57405347e07,
                    8.15704307e07,
                    1.07400327e08,
                    1.33230223e08,
                    1.59060119e08,
                    1.84890015e08,
                    2.10719911e08,
                    2.36549807e08,
                    2.62379703e08,
                    2.88209599e08,
                    3.14039495e08,
                    3.39869391e08,
                    3.65699287e08,
                    3.91529183e08,
                    4.17359079e08,
                    4.43188975e08,
                    4.69018871e08,
                    4.94848767e08,
                    5.20678663e08,
                    5.46508559e08,
                    5.72338455e08,
                    5.98168351e08,
                    6.23998248e08,
                    6.49828144e08,
                    6.75658040e08,
                    7.01487936e08,
                    7.27317832e08,
                    7.53147728e08,
                    7.78977624e08,
                    8.04807520e08,
                    8.30637416e08,
                    8.56467312e08,
                    8.82297208e08,
                    9.08127104e08,
                    9.33957000e08,
                ],
                [
                    5.95069604e08,
                    5.69239708e08,
                    5.43409812e08,
                    5.17579916e08,
                    4.91750020e08,
                    4.65920124e08,
                    4.40090228e08,
                    4.14260332e08,
                    3.88430436e08,
                    3.62600540e08,
                    3.36770644e08,
                    3.10940748e08,
                    2.85110851e08,
                    2.59280955e08,
                    2.33451059e08,
                    2.07621163e08,
                    1.81791267e08,
                    1.55961371e08,
                    1.30131475e08,
                    1.04301579e08,
                    7.84716832e07,
                    5.26417871e07,
                    2.68118911e07,
                    9.81995050e05,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    1.19077426e07,
                    3.77376386e07,
                    6.35675347e07,
                    8.93974307e07,
                    1.15227327e08,
                    1.41057223e08,
                    1.66887119e08,
                    1.92717015e08,
                    2.18546911e08,
                    2.44376807e08,
                    2.70206703e08,
                    2.96036599e08,
                    3.21866495e08,
                    3.47696391e08,
                    3.73526287e08,
                    3.99356183e08,
                    4.25186079e08,
                    4.51015975e08,
                    4.76845871e08,
                    5.02675767e08,
                    5.28505663e08,
                    5.54335559e08,
                    5.88614911e08,
                    6.40274703e08,
                    6.91934495e08,
                    7.43594287e08,
                    7.95254079e08,
                    8.46913871e08,
                    8.98573663e08,
                    9.50233455e08,
                    1.00189325e09,
                    1.05355304e09,
                    1.10521283e09,
                    1.15687262e09,
                    1.20853242e09,
                    1.26019221e09,
                    1.31185200e09,
                ],
                [
                    6.36051208e08,
                    5.84391416e08,
                    5.32731624e08,
                    4.81071832e08,
                    4.29412040e08,
                    3.77752248e08,
                    3.26092455e08,
                    2.74432663e08,
                    2.22772871e08,
                    1.71113079e08,
                    1.19453287e08,
                    6.77934950e07,
                    1.61337030e07,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    2.23432426e07,
                    4.81731386e07,
                    7.40030347e07,
                    9.98329307e07,
                    1.25662827e08,
                    1.51492723e08,
                    1.77322619e08,
                    2.03152515e08,
                    2.28982411e08,
                    2.54812307e08,
                    2.80642203e08,
                    3.06472099e08,
                    3.32301995e08,
                    3.58131891e08,
                    3.83961787e08,
                    4.09791683e08,
                    4.35621579e08,
                    4.61451475e08,
                    4.87281371e08,
                    5.13111267e08,
                    5.38941163e08,
                    5.64771059e08,
                    5.90600955e08,
                    6.16430851e08,
                    6.42260748e08,
                    6.68090644e08,
                    6.93920540e08,
                    7.19750436e08,
                    7.45580332e08,
                    7.71410228e08,
                    7.97240124e08,
                    8.23070020e08,
                    8.48899916e08,
                    8.74729812e08,
                    9.00559708e08,
                    9.26389604e08,
                    9.52219500e08,
                ],
                [
                    5.79415604e08,
                    5.53585708e08,
                    5.27755812e08,
                    5.01925916e08,
                    4.76096020e08,
                    4.50266124e08,
                    4.24436228e08,
                    3.98606332e08,
                    3.72776436e08,
                    3.46946540e08,
                    3.21116644e08,
                    2.95286748e08,
                    2.69456851e08,
                    2.43626955e08,
                    2.17797059e08,
                    1.91967163e08,
                    1.66137267e08,
                    1.40307371e08,
                    1.14477475e08,
                    8.86475792e07,
                    6.28176832e07,
                    3.69877871e07,
                    1.11578911e07,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    4.33884653e06,
                    3.01687426e07,
                    5.59986386e07,
                    8.18285347e07,
                    1.07658431e08,
                    1.33488327e08,
                    1.59318223e08,
                    1.85148119e08,
                    2.10978015e08,
                    2.36807911e08,
                    2.62637807e08,
                    2.88467703e08,
                    3.14297599e08,
                    3.40127495e08,
                    3.65957391e08,
                    3.91787287e08,
                    4.17617183e08,
                    4.43447079e08,
                    4.69276975e08,
                    4.95106871e08,
                    5.20936767e08,
                    5.46766663e08,
                    5.72596559e08,
                    5.98426455e08,
                    6.24256351e08,
                    6.50086248e08,
                    6.75916144e08,
                    7.01746040e08,
                    7.27575936e08,
                    7.53405832e08,
                    7.79235728e08,
                    8.05065624e08,
                    8.30895520e08,
                    8.56725416e08,
                    8.82555312e08,
                    9.08385208e08,
                    9.34215104e08,
                    9.60045000e08,
                ],
                [
                    1.13780352e09,
                    1.06330105e09,
                    9.88798574e08,
                    9.14296099e08,
                    8.39793624e08,
                    7.65291149e08,
                    6.90788673e08,
                    6.16286198e08,
                    5.41783723e08,
                    4.67281248e08,
                    3.92778772e08,
                    3.18276297e08,
                    2.43773822e08,
                    2.00261436e08,
                    1.77418752e08,
                    1.54576069e08,
                    1.31733386e08,
                    1.08890703e08,
                    8.60480198e07,
                    6.32053366e07,
                    4.03626535e07,
                    1.75199703e07,
                    3.19143564e05,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    1.90694554e06,
                    1.33282871e07,
                    2.47496287e07,
                    3.61709703e07,
                    6.09407822e07,
                    9.81920198e07,
                    1.35443257e08,
                    1.72694495e08,
                    2.09945733e08,
                    2.47196970e08,
                    2.84448208e08,
                    3.21699446e08,
                    3.58950683e08,
                    3.96201921e08,
                    4.33453158e08,
                    4.70704396e08,
                    5.07955634e08,
                    5.45206871e08,
                    5.82458109e08,
                    6.19709347e08,
                    6.56960584e08,
                    6.94211822e08,
                    7.31463059e08,
                    7.68714297e08,
                    8.05965535e08,
                    8.43216772e08,
                    8.80468010e08,
                    9.17719248e08,
                    9.54970485e08,
                    9.92221723e08,
                    1.02947296e09,
                    1.06672420e09,
                    1.10397544e09,
                    1.14122667e09,
                    1.17847791e09,
                    1.21572915e09,
                    1.25298039e09,
                    1.29023162e09,
                    1.32748286e09,
                    1.36473410e09,
                    1.40198534e09,
                    1.43923657e09,
                    1.47648781e09,
                    1.51373905e09,
                    1.55099029e09,
                    1.58824152e09,
                    1.62549276e09,
                    1.66274400e09,
                ],
            ]
        )
    )
