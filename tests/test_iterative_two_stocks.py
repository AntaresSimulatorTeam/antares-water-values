import numpy as np
import pytest

from functions_iterative import ReservoirManagement, TimeScenarioParameter
from multi_stock_bellman_value_calculation import *
from read_antares_data import Reservoir
from reservoir_management import MultiStockManagement
from type_definition import time_list_area_value_to_array


def test_bellman_value_iterative_method() -> None:

    param = TimeScenarioParameter(len_week=5, len_scenario=1)

    reservoir_1 = Reservoir("test_data/two_nodes", "area_1")
    reservoir_management_1 = ReservoirManagement(
        reservoir=reservoir_1,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    reservoir_2 = Reservoir("test_data/two_nodes", "area_2")
    reservoir_management_2 = ReservoirManagement(
        reservoir=reservoir_2,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    multi_management = MultiStockManagement(
        [reservoir_management_1, reservoir_management_2]
    )

    (
        bell_costs,
        cost_approx,
        _,
        levels,
        opt_trajectory,
        _,
    ) = iter_bell_vals(
        param=param,
        multi_stock_management=multi_management,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        saving_dir="dev/test",
        name_solver="CLP",
        nSteps_bellman=5,
        starting_pt={
            a: mng.reservoir.bottom_rule_curve[0] * 0.7
            + mng.reservoir.upper_rule_curve[0] * 0.3
            for a, mng in multi_management.dict_reservoirs.items()
        },
        precision=1e-3,
        method="lines",
        correlations=None,
        divisor={"euro": 1e8, "energy": 1e4},
        verbose=False,
    )

    assert cost_approx.estimators[TimeScenarioIndex(0, 0)].inputs == pytest.approx(
        np.array(
            [
                [0.0, -322182.0],
                [306936.0, 419664.0],
                [-0.0, 419664.0],
                [73173.435482, 419663.750788],
                [73173.435482, 419663.750788],
            ]
        )
    )

    assert np.array(
        [[c for c in bell_costs[WeekIndex(w)]] for w in range(param.len_week)]
    ) == pytest.approx(
        np.array(
            [
                [
                    1.00000082e16,
                    1.00000026e16,
                    1.00000029e16,
                    1.00000013e16,
                    1.00000007e16,
                    1.00000013e16,
                    1.00000008e16,
                    1.00000028e16,
                    1.00000014e16,
                    1.00000059e16,
                ],
                [
                    1.00000098e16,
                    1.00000049e16,
                    1.00000048e16,
                    1.00000034e16,
                    1.00000017e16,
                    1.00000034e16,
                    1.00000008e16,
                    1.00000047e16,
                    1.00000010e16,
                    1.00000082e16,
                ],
                [
                    1.00000086e16,
                    1.00000063e16,
                    1.00000039e16,
                    1.00000027e16,
                    1.00000009e16,
                    1.00000027e16,
                    1.00000008e16,
                    1.00000036e16,
                    1.00000013e16,
                    1.00000062e16,
                ],
                [
                    1.00000072e16,
                    1.00000055e16,
                    1.00000029e16,
                    1.00000018e16,
                    1.00000001e16,
                    1.00000018e16,
                    1.00000005e16,
                    1.00000028e16,
                    1.00000009e16,
                    1.00000052e16,
                ],
                [
                    1.00000056e16,
                    1.00000035e16,
                    1.00000027e16,
                    1.00000017e16,
                    1.00000000e16,
                    1.00000017e16,
                    1.00000004e16,
                    1.00000027e16,
                    1.00000008e16,
                    1.00000050e16,
                ],
            ]
        )
    )

    assert time_list_area_value_to_array(levels, param, multi_management.areas)[
        ::-1
    ] == pytest.approx(
        np.array(
            [
                [
                    [0.0, 419150.30528],
                    [347041.07, 0.0],
                    [175340.436, 419150.30528],
                    [347041.07, 396540.564],
                    [409896.721, 419150.30528],
                    [347041.07, 927000.529],
                    [589466.8605, 419150.30528],
                    [347041.07, 1333106.7645],
                    [769037.0, 419150.30528],
                    [347041.07, 1739213.0],
                ],
                [
                    [0.0, 396540.564],
                    [333244.07, 0.0],
                    [178416.584, 396540.564],
                    [333244.07, 403497.416],
                    [486031.384, 396540.564],
                    [333244.07, 1099182.616],
                    [627534.192, 396540.564],
                    [333244.07, 1419197.808],
                    [769037.0, 396540.564],
                    [333244.07, 1739213.0],
                ],
                [
                    [0.0, 403497.416],
                    [319468.07, 0.0],
                    [180723.695, 403497.416],
                    [319468.07, 408715.055],
                    [488338.495, 403497.416],
                    [319468.07, 1104400.255],
                    [628687.7475, 403497.416],
                    [319468.07, 1421806.6275],
                    [769037.0, 403497.416],
                    [319468.07, 1739213.0],
                ],
                [
                    [0.0, 652959.3016887],
                    [305692.07, 0.0],
                    [183030.806, 652959.3016887],
                    [305692.07, 413932.694],
                    [491414.643, 652959.3016887],
                    [305692.07, 1111357.107],
                    [630225.8215, 652959.3016887],
                    [305692.07, 1425285.0535],
                    [769037.0, 652959.3016887],
                    [305692.07, 1739213.0],
                ],
                [
                    [0.0, 413932.694],
                    [291825.07, 0.0],
                    [185337.917, 413932.694],
                    [291825.07, 419150.333],
                    [493721.754, 413932.694],
                    [291825.07, 1116574.746],
                    [631379.377, 413932.694],
                    [291825.07, 1427893.873],
                    [769037.0, 413932.694],
                    [291825.07, 1739213.0],
                ],
            ]
        )
    )

    assert timescenario_area_value_to_array(
        opt_trajectory, param, multi_management.areas
    ) == pytest.approx(
        np.array(
            [
                [[291825.07, 413932.694]],
                [[305692.07, 652959.3016887]],
                [[319468.07, 861645.70886979]],
                [[333244.07, 473537.71]],
                [[347041.07, 366973.943]],
            ]
        )
    )


def test_bellman_value_iterative_method_with_sddp() -> None:

    param = TimeScenarioParameter(len_week=5, len_scenario=1)

    reservoir_1 = Reservoir("test_data/two_nodes", "area_1")
    reservoir_management_1 = ReservoirManagement(
        reservoir=reservoir_1,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    reservoir_2 = Reservoir("test_data/two_nodes", "area_2")
    reservoir_management_2 = ReservoirManagement(
        reservoir=reservoir_2,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    multi_management = MultiStockManagement(
        [reservoir_management_1, reservoir_management_2]
    )

    _, bellman_costs, _, _ = iter_bell_vals_v2(
        param=param,
        multi_stock_management=multi_management,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        saving_dir="dev/test",
        starting_pt={
            area: mng.reservoir.bottom_rule_curve[0] * 0.7
            + mng.reservoir.upper_rule_curve[0] * 0.3
            for area, mng in multi_management.dict_reservoirs.items()
        },
        normalization={"euro": 1e9, "energy": 1e4},
        name_solver="CLP",
        maxiter=3,
        precision=1e-2,
        verbose=False,
    )

    assert np.array(bellman_costs) == pytest.approx(
        np.array(
            [
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    1.08894279e09,
                    1.03183608e09,
                    9.74729376e08,
                    9.17622668e08,
                    8.60515960e08,
                    8.03409252e08,
                    7.46302545e08,
                    6.89195837e08,
                    6.32089129e08,
                    5.74982421e08,
                    5.17875713e08,
                    4.60769005e08,
                    4.03662297e08,
                    3.46555589e08,
                    2.89448881e08,
                    2.32342173e08,
                    1.75235465e08,
                    1.36094554e08,
                    1.01830530e08,
                    6.75665050e07,
                    4.03626535e07,
                    1.75199703e07,
                    3.19143564e05,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    1.33484703e07,
                    3.91783663e07,
                    6.50082624e07,
                    9.08381584e07,
                    1.16668054e08,
                    1.42497950e08,
                    1.68327847e08,
                    1.94157743e08,
                    2.19987639e08,
                    2.45817535e08,
                    2.71647431e08,
                    2.97477327e08,
                    3.23307223e08,
                    3.49137119e08,
                    3.74967015e08,
                    4.09547347e08,
                    4.46798584e08,
                    4.84049822e08,
                    5.21301059e08,
                    5.58552297e08,
                    5.95803535e08,
                    6.33054772e08,
                    6.70306010e08,
                    7.07557248e08,
                    7.44808485e08,
                    7.82059723e08,
                    8.19310960e08,
                    8.56562198e08,
                    8.93813436e08,
                    9.31064673e08,
                    9.68315911e08,
                    1.00556715e09,
                    1.04281839e09,
                    1.08006962e09,
                    1.11732086e09,
                    1.15457210e09,
                    1.19182334e09,
                    1.22907457e09,
                    1.26632581e09,
                    1.30357705e09,
                    1.34082829e09,
                    1.37807952e09,
                    1.41533076e09,
                    1.45258200e09,
                ],
            ]
        )
    )
