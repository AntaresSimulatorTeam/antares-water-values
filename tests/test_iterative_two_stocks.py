import numpy as np
import pytest

from functions_iterative import ReservoirManagement, TimeScenarioParameter
from multi_stock_bellman_value_calculation import *
from read_antares_data import Reservoir
from reservoir_management import MultiStockManagement
from type_definition import time_list_area_value_to_array


def test_bellman_value_iterative_method(param: TimeScenarioParameter) -> None:

    reservoir_1 = Reservoir("test_data/two_nodes", "area_1")
    reservoir_management_1 = ReservoirManagement(
        reservoir=reservoir_1,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    reservoir_2 = Reservoir("test_data/two_nodes", "area_2")
    reservoir_management_2 = ReservoirManagement(
        reservoir=reservoir_2,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    multi_management = MultiStockManagement(
        [reservoir_management_1, reservoir_management_2]
    )

    (
        bell_costs,
        cost_approx,
        _,
        levels,
        opt_trajectory,
        _,
    ) = iter_bell_vals(
        param=param,
        multi_stock_management=multi_management,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        saving_dir="dev/test",
        name_solver="CLP",
        nSteps_bellman=5,
        starting_pt={
            a: mng.reservoir.bottom_rule_curve[0] * 0.7
            + mng.reservoir.upper_rule_curve[0] * 0.3
            for a, mng in multi_management.dict_reservoirs.items()
        },
        precision=1e-3,
        method="lines",
        correlations=None,
        divisor={"euro": 1e8, "energy": 1e4},
        verbose=False,
    )

    assert cost_approx.estimators[TimeScenarioIndex(0, 0)].inputs == pytest.approx(
        np.array(
            [
                [0.0, -322182.0],
                [306936.0, 419664.0],
                [-0.0, 419664.0],
                [73173.435482, 419663.750788],
                [73173.435482, 419663.750788],
            ]
        )
    )

    assert np.array(
        [[c for c in bell_costs[WeekIndex(w)]] for w in range(param.len_week)]
    ) == pytest.approx(
        np.array(
            [
                [
                    7.76674441e09,
                    4.80369515e09,
                    5.40618880e09,
                    4.34131730e09,
                    2.37118782e09,
                    4.34131730e09,
                    1.40758441e09,
                    4.34131730e09,
                    8.39921586e08,
                    5.06192598e09,
                ],
                [
                    9.74681995e09,
                    9.10017825e09,
                    7.27650554e09,
                    6.04989294e09,
                    4.19266724e09,
                    6.04989294e09,
                    2.80455544e09,
                    6.04989294e09,
                    1.71624509e09,
                    6.79063717e09,
                ],
                [
                    8.64975258e09,
                    8.27833372e09,
                    5.99586240e09,
                    4.88621754e09,
                    2.91971430e09,
                    4.60841860e09,
                    1.51622180e09,
                    4.60841860e09,
                    5.27694940e08,
                    5.47221713e09,
                ],
                [
                    7.62534237e09,
                    6.51876717e09,
                    4.82719701e09,
                    3.63892261e09,
                    1.85896484e09,
                    3.27892211e09,
                    1.29872290e09,
                    3.59118995e09,
                    1.15722009e09,
                    4.83681365e09,
                ],
                [
                    8.42522049e09,
                    4.16306576e09,
                    5.52260982e09,
                    3.80560352e09,
                    3.17704702e09,
                    3.80560352e09,
                    1.82419566e09,
                    4.03718694e09,
                    1.10591510e09,
                    5.25550566e09,
                ],
            ]
        )
    )

    assert time_list_area_value_to_array(levels, param, multi_management.areas)[
        ::-1
    ] == pytest.approx(
        np.array(
            [
                [
                    [0.0, 867867.287],
                    [347041.07, 0.0],
                    [175340.436, 867867.287],
                    [347041.07, 396540.564],
                    [409896.721, 867867.287],
                    [347041.07, 927000.529],
                    [589466.8605, 867867.287],
                    [347041.07, 1333106.7645],
                    [769037.0, 867867.287],
                    [347041.07, 1739213.0],
                ],
                [
                    [0.0, 874681.07767224],
                    [333244.07, 0.0],
                    [178416.584, 874681.07767224],
                    [333244.07, 403497.416],
                    [486031.384, 874681.07767224],
                    [333244.07, 1099182.616],
                    [627534.192, 874681.07767224],
                    [333244.07, 1419197.808],
                    [769037.0, 874681.07767224],
                    [333244.07, 1739213.0],
                ],
                [
                    [0.0, 1001638.10309647],
                    [319468.07, 0.0],
                    [180723.695, 1001638.10309647],
                    [319468.07, 408715.055],
                    [488338.495, 1001638.10309647],
                    [319468.07, 1104400.255],
                    [628687.7475, 1001638.10309647],
                    [319468.07, 1421806.6275],
                    [769037.0, 1001638.10309647],
                    [319468.07, 1739213.0],
                ],
                [
                    [0.0, 979455.23183235],
                    [305692.07, 0.0],
                    [183030.806, 979455.23183235],
                    [305692.07, 413932.694],
                    [491414.643, 979455.23183235],
                    [305692.07, 1111357.107],
                    [630225.8215, 979455.23183235],
                    [305692.07, 1425285.0535],
                    [769037.0, 979455.23183235],
                    [305692.07, 1739213.0],
                ],
                [
                    [0.0, 888184.40213413],
                    [291825.07, 0.0],
                    [185337.917, 888184.40213413],
                    [291825.07, 419150.333],
                    [493721.754, 888184.40213413],
                    [291825.07, 1116574.746],
                    [631379.377, 888184.40213413],
                    [291825.07, 1427893.873],
                    [769037.0, 888184.40213413],
                    [291825.07, 1739213.0],
                ],
            ]
        )
    )

    assert timescenario_area_value_to_array(
        opt_trajectory, param, multi_management.areas
    ) == pytest.approx(
        np.array(
            [
                [[291825.07, 888184.40213413]],
                [[180723.695, 501314.68423129]],
                [[194499.69, 523497.55309647]],
                [[175340.436, 396540.52767224]],
                [[162266.807, 366973.943]],
            ]
        )
    )


def test_bellman_value_iterative_method_with_sddp(param: TimeScenarioParameter) -> None:

    reservoir_1 = Reservoir("test_data/two_nodes", "area_1")
    reservoir_management_1 = ReservoirManagement(
        reservoir=reservoir_1,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    reservoir_2 = Reservoir("test_data/two_nodes", "area_2")
    reservoir_management_2 = ReservoirManagement(
        reservoir=reservoir_2,
        penalty_bottom_rule_curve=3000,
        penalty_upper_rule_curve=3000,
        penalty_final_level=3000,
        force_final_level=True,
    )

    multi_management = MultiStockManagement(
        [reservoir_management_1, reservoir_management_2]
    )

    _, bellman_costs, _, _ = iter_bell_vals_v2(
        param=param,
        multi_stock_management=multi_management,
        n_controls_init=2,
        output_path="test_data/two_nodes",
        saving_dir="dev/test",
        starting_pt={
            area: mng.reservoir.bottom_rule_curve[0] * 0.7
            + mng.reservoir.upper_rule_curve[0] * 0.3
            for area, mng in multi_management.dict_reservoirs.items()
        },
        normalization={"euro": 1e9, "energy": 1e4},
        name_solver="CLP",
        maxiter=3,
        precision=1e-2,
        verbose=False,
    )

    assert np.array(bellman_costs) == pytest.approx(
        np.array(
            [
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                ],
                [
                    1.08894279e09,
                    1.03183608e09,
                    9.74729376e08,
                    9.17622668e08,
                    8.60515960e08,
                    8.03409252e08,
                    7.46302545e08,
                    6.89195837e08,
                    6.32089129e08,
                    5.74982421e08,
                    5.17875713e08,
                    4.60769005e08,
                    4.03662297e08,
                    3.46555589e08,
                    2.89448881e08,
                    2.32342173e08,
                    1.75235465e08,
                    1.36094554e08,
                    1.01830530e08,
                    6.75665050e07,
                    4.03626535e07,
                    1.75199703e07,
                    3.19143564e05,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    0.00000000e00,
                    1.33484703e07,
                    3.91783663e07,
                    6.50082624e07,
                    9.08381584e07,
                    1.16668054e08,
                    1.42497950e08,
                    1.68327847e08,
                    1.94157743e08,
                    2.19987639e08,
                    2.45817535e08,
                    2.71647431e08,
                    2.97477327e08,
                    3.23307223e08,
                    3.49137119e08,
                    3.74967015e08,
                    4.09547347e08,
                    4.46798584e08,
                    4.84049822e08,
                    5.21301059e08,
                    5.58552297e08,
                    5.95803535e08,
                    6.33054772e08,
                    6.70306010e08,
                    7.07557248e08,
                    7.44808485e08,
                    7.82059723e08,
                    8.19310960e08,
                    8.56562198e08,
                    8.93813436e08,
                    9.31064673e08,
                    9.68315911e08,
                    1.00556715e09,
                    1.04281839e09,
                    1.08006962e09,
                    1.11732086e09,
                    1.15457210e09,
                    1.19182334e09,
                    1.22907457e09,
                    1.26632581e09,
                    1.30357705e09,
                    1.34082829e09,
                    1.37807952e09,
                    1.41533076e09,
                    1.45258200e09,
                ],
            ]
        )
    )
